// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // Supabase connection string
}

enum user_role {
  visitor
  user
  author
  moderator
  admin
}

enum article_status {
  draft
  pending
  approved
  rejected
}

enum notification_type {
  article_approved
  comment_on_article
  like_on_article
}

model users {
  id         String    @id @db.Uuid
  email      String?   @unique @db.Citext
  first_name String?
  last_name  String?
  nickname   String    @unique
  avatar_url String?
  bio        String?
  role       user_role @default(user)
  created_at DateTime  @default(now()) @db.Timestamptz(6)
  updated_at DateTime  @default(now()) @db.Timestamptz(6)
  deleted_at DateTime? @db.Timestamptz(6)

  articles   articles[]
  photos     article_photos[]
  comments   comments[]
  likes      article_likes[]
  notifications_received notifications[] @relation("NotifRecipient")
  notifications_acted    notifications[] @relation("NotifActor")
  visited_countries      user_visited_countries[]
  approved_articles      articles[]       @relation("ArticleApprover")
}

model countries {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  iso_code   String  @unique
  name       String
  continent  String
  flag_emoji String?
  flag_url   String?
  lat        Float?
  lng        Float?

  destinations destinations[]
  visitedBy    user_visited_countries[]
}

model user_visited_countries {
  user_id    String   @db.Uuid
  country_id String   @db.Uuid
  visited_at DateTime @default(now()) @db.Timestamptz(6)
  note       String?

  user    users     @relation(fields: [user_id], references: [id])
  country countries @relation(fields: [country_id], references: [id])

  @@id([user_id, country_id])
}

model destinations {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  country_id  String   @db.Uuid
  name        String
  slug        String   @unique
  description String?
  lat         Float?
  lng         Float?
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  updated_at  DateTime @default(now()) @db.Timestamptz(6)

  country countries @relation(fields: [country_id], references: [id])
  articles articles[]
}

model articles {
  id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  author_id      String         @db.Uuid
  destination_id String?        @db.Uuid
  title          String
  slug           String         @unique
  summary        String?
  content        String
  status         article_status @default(draft)
  likes_count    Int            @default(0)
  comments_count Int            @default(0)
  published_at   DateTime?      @db.Timestamptz(6)
  approved_at    DateTime?      @db.Timestamptz(6)
  approved_by    String?        @db.Uuid
  rejected_reason String?
  created_at     DateTime       @default(now()) @db.Timestamptz(6)
  updated_at     DateTime       @default(now()) @db.Timestamptz(6)
  deleted_at     DateTime?      @db.Timestamptz(6)

  author      users        @relation(fields: [author_id], references: [id])
  destination destinations? @relation(fields: [destination_id], references: [id])
  approver    users?       @relation("ArticleApprover", fields: [approved_by], references: [id])
  photos      article_photos[]
  comments    comments[]
  likes       article_likes[]
  notifications notifications[]

  @@index([author_id])
  @@index([status, published_at])
  @@index([destination_id])
}

model article_photos {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  article_id String   @db.Uuid
  author_id  String   @db.Uuid
  url        String
  alt        String?
  width      Int?
  height     Int?
  created_at DateTime @default(now()) @db.Timestamptz(6)

  article articles @relation(fields: [article_id], references: [id])
  author  users    @relation(fields: [author_id], references: [id])

  @@index([article_id])
}

model comments {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  article_id String   @db.Uuid
  author_id  String   @db.Uuid
  body       String
  created_at DateTime @default(now()) @db.Timestamptz(6)
  deleted_at DateTime? @db.Timestamptz(6)

  article articles @relation(fields: [article_id], references: [id])
  author  users    @relation(fields: [author_id], references: [id])

  @@index([article_id])
  @@index([author_id])
}

model article_likes {
  article_id String @db.Uuid
  user_id    String @db.Uuid
  created_at DateTime @default(now()) @db.Timestamptz(6)

  article articles @relation(fields: [article_id], references: [id])
  user    users    @relation(fields: [user_id], references: [id])

  @@id([article_id, user_id])
}

model notifications {
  id           String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  recipient_id String            @db.Uuid
  type         notification_type
  article_id   String?           @db.Uuid
  actor_id     String?           @db.Uuid
  payload      Json?
  is_read      Boolean           @default(false)
  created_at   DateTime          @default(now()) @db.Timestamptz(6)

  recipient users        @relation("NotifRecipient", fields: [recipient_id], references: [id])
  article   articles?    @relation(fields: [article_id], references: [id])
  actor     users?       @relation("NotifActor", fields: [actor_id], references: [id])

  @@index([recipient_id, is_read, created_at])
}