## Uživatelské články a komentáře s moderací – technický plán

Krátký popis: Přidat do aplikace kompletní tok pro cestovatelské články (vytváření, editace, stavy draft/pending/published/rejected), komentáře včetně jedné úrovně odpovědí a lajků na komentářích, uživatelskou správu v dashboardu („Moje články“) a admin rozhraní pro moderaci článků i komentářů. Obrázky (cover i galerie) se nahrávají na Cloudinary, v DB se ukládají pouze metadata.

### Relevantní soubory a oblasti

- Autentizace a uživatelé: `src/hooks/useAuth.tsx`, `src/utils/supabase.ts`, `src/lib/supabase/{client,server,admin}.ts`, `src/types/auth.ts`, DB tabulka `users.role` (Prisma).
- Schéma DB (Prisma): `prisma/schema.prisma` (modely `articles`, `article_photos`, `comments`, `article_likes`, `users`, enumy `user_role`, `article_status`).
- Dashboard uživatele: `src/app/dashboard/page.tsx`, `src/components/dashboard/ArticlesList.tsx` (sekce „Moje články“ – rozšířit), nové stránky pro editor článků.
- Veřejné/komunitní zobrazení článků (pro pozdější napojení): `src/components/articles/ArticlesTeaser.tsx`.
- API (Next.js App Router – route handlers): nově pod `src/app/api/...` (viz níže).
- Cloudinary: závislost `next-cloudinary` (již v `package.json`), nutné doplnit podpisovací endpoint a povolit doménu v `next.config.ts`.

### Datová vrstva (DB a typy)

- Schéma existuje a pokrývá většinu požadavků, doplnění/úpravy:
  - `articles`:
    - Přidat sloupce pro hlavní obrázek (cover): `main_image_url TEXT`, `main_image_public_id TEXT`, `main_image_width INT`, `main_image_height INT`, `main_image_alt TEXT?`.
    - Pozn.: enum `article_status` již obsahuje `draft`, `pending`, `approved`, `rejected`. V UI budeme zobrazovat „published“ ↔ mapuje se na `approved` (neměníme enum; pouze překlad v UI).
  - `article_photos` (již existuje): ukládá 1:N fotky ke článku. Využijeme pole: `url`, `alt?`, `width?`, `height?`, včetně `article_id` a `author_id`.
  - `comments`:
    - Přidat `parent_id UUID?` (FK na `comments.id`) pro „jednu úroveň odpovědí“. Indexovat `parent_id`. Aplikačně vynutíme max. hloubku 1: pokud `parent_id` není null, nesmí mít nadřazený komentář vlastní `parent_id`.
  - Lajky na komentářích:
    - Nová tabulka `comment_likes { comment_id UUID, user_id UUID, created_at timestamptz, PK (comment_id, user_id) }` + FK na `comments`/`users`.
  - Počítadla (volitelné, pro výkon a jednoduché listy):
    - `articles.comments_count` (již existuje), `articles.likes_count` (již existuje).
    - Lze doplnit `comments.likes_count` (není nutné, dá se agregovat; případně přidat později).
  - Migrace: upravit `prisma/schema.prisma` a provést `prisma migrate dev`, poté regenerovat klienta.

### Upload obrázků (Cloudinary)

- Frontend vždy nahrává na Cloudinary, DB ukládá pouze metadata.
- Serverový podpis (bezpečné uploady): přidat endpoint:
  - `src/app/api/images/signature/route.ts`: vrací podpis pro upload (timestamp, signature) dle Cloudinary API. Použít server-only konfiguraci (env s `CLOUDINARY_API_SECRET`).
  - Frontend použije `next-cloudinary` (např. `CldUploadWidget`) nebo fetch na Cloudinary REST s podpisem.
- Po úspěšném uploadu frontend volá vlastní API pro zápis metadat:
  - Cover: PUT na `/api/articles/[id]/cover` s `{ url, public_id, width, height, alt? }` → uloží do `articles` (hlavní obrázek).
  - Galerie: POST `/api/articles/[id]/photos` (přidání), DELETE `/api/articles/[id]/photos/[photoId]` (odebrání).
- Obrázky v Next/Image: doplnit povolený hostitel do `next.config.ts` → `images.remotePatterns` přidat `res.cloudinary.com`.

### API rozhraní (route handlers)

- Autentizace: při každém mutačním volání načíst current user (`createServerSupabaseClient() → auth.getUser()`), následně dotaz do `users` pro zjištění role (kvůli admin funkcím).
- Články:
  - `POST /api/articles` – vytvoření článku (pouze přihlášený uživatel). Tělo: `title`, `summary?`, `content`, `tags?` (pokud používáme), volitelně `destination_id`. Nastaví `author_id`, výchozí `status = draft` (případně endpoint `POST /api/articles/[id]/submit` pro přechod do `pending`).
  - `GET /api/articles?mine=true` – seznam vlastních článků (pouze přihlášený). Vrací `title`, `created_at`, `updated_at`, `status`.
  - `GET /api/articles/[id]` – detail článku. Viditelnost: autor, admin; veřejně pouze pokud `status = approved` (UI label „published“).
  - `PUT /api/articles/[id]` – editace článku (jen autor nebo admin). Uloží změny, aktualizuje `updated_at`. Pozn.: do budoucna: pokud článek je `approved` a dojde k „větší změně“ (např. `title`, `content`, `main_image_*`), změnit na `pending`. Teď pouze zmíníme a necháme jako volitelnou logiku (feature flag / TODO).
  - `POST /api/articles/[id]/submit` – autor odešle koncept do schvalování (`status → pending`).
  - `PUT /api/articles/[id]/cover` – nastavení cover image metadat.
  - `POST /api/articles/[id]/photos` – přidání záznamu do `article_photos`.
  - `DELETE /api/articles/[id]/photos/[photoId]` – smazání fotky z galerie (autor nebo admin).
- Komentáře:
  - `GET /api/articles/[id]/comments` – načtení seznamu (top-level + vnořené odpovědi, max. 1 úroveň).
  - `POST /api/articles/[id]/comments` – vytvoření komentáře (přihlášený uživatel). Tělo: `body`, volitelně `parent_id` (pouze pokud parent je top-level).
  - `DELETE /api/comments/[id]` – smazání komentáře (pouze autor komentáře nebo admin). Implementace: server ověří `comment.author_id === currentUserId` nebo `role === admin`.
  - `POST /api/comments/[id]/like` – toggle like (přihlášený, jeden like na komentář). Implementace: `INSERT ... ON CONFLICT DO NOTHING` → vrací stav a aktuální count; `DELETE` pro zrušení.
- Moderace (admin):
  - `GET /api/admin/articles?status=pending&author=...&from=...&to=...` – listing s filtrováním.
  - `POST /api/admin/articles/[id]/approve` – schválení (`status → approved`, `approved_at`, `approved_by`), volitelná notifikace.
  - `POST /api/admin/articles/[id]/reject` – zamítnutí (`status → rejected`, `rejected_reason?`).
  - `GET /api/admin/comments?reported=true|latest` – přehled komentářů pro moderaci.
  - `DELETE /api/admin/comments/[id]` – mazání/skrývání nevhodného obsahu.

### Oprávnění a pravidla

- Vytvářet články: přihlášený uživatel.
- Vidět a spravovat „Moje články“: pouze autor (vlastní záznamy).
- Komentáře:
  - Vytváření: přihlášený uživatel.
  - Odpovědi: `parent_id` může odkazovat pouze na top-level komentář k témuž článku (aplikace zamezí hlubšímu vnoření).
  - Mazání: pouze autor komentáře nebo admin.
  - Lajkování: přihlášený uživatel, max. 1 like na komentář (vynuceno PK `(comment_id, user_id)`).
- Admin práva:
  - Schvalování/odmítání článků, mazání/skrývání komentářů, přístup ke všem článkům/komentářům v rámci moderace.
  - Kontrola role: načíst `users.role` a v route handlers vynutit `role === 'admin'`.

### UI – uživatelský dashboard („Moje články“)

- Rozšířit `src/app/dashboard/page.tsx` (tab „articles“):
  - V `ArticlesList` zobrazit: `název`, `created_at`, `updated_at`, `status` (draft/pending/published/rejected – mapováno z `draft/pending/approved/rejected`).
  - Tlačítka: „Nový článek“ (navigace na editor nového), „Upravit“ u každé položky.
- Editor článku:
  - Nové stránky: `src/app/dashboard/articles/new/page.tsx`, `src/app/dashboard/articles/[id]/edit/page.tsx`.
  - Form fields: `title`, `summary` (perex), `content`, `tags?`, `cover image` (Cloudinary upload + uložení metadat), galerie (přidat/odebrat fotky přes API).
  - Akce: Uložit (PUT), Odeslat ke schválení (POST submit → `pending`). Po uložení aktualizovat `updated_at`.
  - Pozn.: Do budoucna možná automatická změna `approved → pending` při větší změně (zmíníme v UI textem).

### UI – admin dashboard (moderace)

- Nová sekce `src/app/admin/articles/page.tsx`:
  - Výpis `pending` článků, možnost filtrovat podle `status`, `autora`, data, náhled cover + galerie (URL Cloudinary).
  - Akce: Schválit (status → `approved`), Zamítnout (status → `rejected` s volitelným důvodem).
- Nová sekce `src/app/admin/comments/page.tsx`:
  - Přehled komentářů (např. nejnovější, případně nahlášené – reporting lze doplnit později).
  - Akce: Mazat/skrývat komentáře.
- Ochrana rout: pouze admin (kontrola role na serveru; volitelně Next middleware pro přesměrování).

### Algoritmy a procesy (stručně)

- „Jedna úroveň odpovědí“: Při `POST /comments` s `parent_id` aplikace nejprve načte parent komentář; pokud parent má `parent_id != null`, request vrátí 400. Dále ověří shodu `article_id` parenta a nového komentáře.
- Toggle like komentáře: Server zjistí, zda existuje `comment_likes(comment_id, user_id)`. Pokud ne, vloží záznam (a volitelně zvýší `comments.likes_count`). Pokud existuje, smaže (unlike). Vrací boolean `liked` + aktuální `likesCount`.
- Počítadla článku: Po přidání/smazání komentáře nebo like na komentáři lze aktualizovat agregované hodnoty v `articles` (buď triggerem v DB, nebo aplikačně po operaci).
- Viditelnost článku: Neautorizovaný/ostatní uživatelé načítají pouze `approved` články. Autor a admin vidí draft/pending/rejected přes „moje články“ a admin rozhraní.

### Fáze implementace

1. Data layer (Prisma):
   - Upravit `prisma/schema.prisma`: přidat `main_image_*`, `comments.parent_id`, novou tabulku `comment_likes` (+ indexy/FK).
   - Migrace a regenerace klienta.
     2A) API:
   - Implementovat endpoints pro články, cover/galerii, komentáře, lajky a admin moderaci.
   - Oprávnění v každém handleru (autor vs admin).
     2B) UI – uživatel:
   - Rozšířit „Moje články“, přidat stránky editoru, napojit Cloudinary upload a API.
     2C) UI – admin:
   - Přidat seznam pending článků s filtrováním a akcemi; stránku komentářů.
2. Cloudinary a Next Image:
   - Přidat `images.remotePatterns` pro Cloudinary; podpisový endpoint pro uploady.

### Napojení na existující kód

- `src/app/dashboard/page.tsx` již načítá články přes `dbUtils.getArticles` a filtruje podle autora; rozšířit pro statusy, edit a navigaci.
- `src/components/dashboard/ArticlesList.tsx` rozšířit o sloupce status/akce a napojit na nové routy editoru.
- `src/lib/supabase/admin.ts` použít pro server-side operace, kde je třeba obejít RLS; přesto vždy autorizovat aplikačně (role/autor).
- `next.config.ts` – přidat Cloudinary hostitele k `images.remotePatterns`.

### Poznámky k terminologii statusů

- DB enum: `draft`, `pending`, `approved`, `rejected`.
- UI popisky: `draft` → „draft“, `pending` → „pending/ke schválení“, `approved` → „published“, `rejected` → „rejected/odmítnutý“.
