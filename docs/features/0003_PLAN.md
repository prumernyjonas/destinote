# 0003 – Sledování uživatelů a veřejné profily

## Popis

Funkce umožní uživatelům se vzájemně sledovat. Každý uživatel bude mít veřejný profil s počty sledujících/sledovaných a možností prokliku na jejich seznam. "Přátelé" = uživatelé, kteří se vzájemně sledují (obousměrné sledování).

**Pravidla:**
- Uživatel nemůže sledovat sám sebe
- Uživatel nemůže sledovat jednu osobu vícekrát (unique constraint)
- Uživatel může sledování kdykoli zrušit

---

## Fáze 1 – Datová vrstva

### 1.1 Prisma schema (`prisma/schema.prisma`)

Přidat nový model `user_follows`:

```prisma
model user_follows {
  follower_id  String   @db.Uuid
  following_id String   @db.Uuid
  created_at   DateTime @default(now()) @db.Timestamptz(6)

  follower  users @relation("UserFollowers", fields: [follower_id], references: [id])
  following users @relation("UserFollowing", fields: [following_id], references: [id])

  @@id([follower_id, following_id])
  @@index([follower_id])
  @@index([following_id])
}
```

Aktualizovat model `users` o relace:
```prisma
// Na konec users modelu přidat:
followers user_follows[] @relation("UserFollowing")  // kdo mě sleduje
following user_follows[] @relation("UserFollowers")  // koho sleduji
```

### 1.2 Databázová migrace

Spustit `npx prisma migrate dev` pro vytvoření tabulky v Supabase.

### 1.3 RLS politiky (`docs/sql/rls_policies.sql`)

Přidat RLS pro `user_follows`:
- SELECT: všichni autentizovaní (profily jsou veřejné)
- INSERT: pouze `auth.uid() = follower_id` a `follower_id != following_id`
- DELETE: pouze `auth.uid() = follower_id`

### 1.4 Typy (`src/types/database.ts`)

Přidat:
```typescript
export interface UserFollow {
  followerId: string;
  followingId: string;
  createdAt: Date;
}

export interface PublicProfile {
  id: string;
  nickname: string;
  displayName: string;
  avatarUrl: string | null;
  bio: string | null;
  countriesVisited: number;
  articlesWritten: number;
  followersCount: number;
  followingCount: number;
  isFollowedByMe: boolean;  // pro aktuálního uživatele
  isFollowingMe: boolean;   // zda mě sleduje zpět
}
```

---

## Fáze 2A – API Endpoints

### 2A.1 Follow/Unfollow API (`src/app/api/users/[id]/follow/route.ts`)

**POST** – Začít sledovat uživatele
- Validace: `followerId !== followingId`
- Upsert do `user_follows` s `onConflict` (ignorovat duplikáty)
- Vrátit `{ ok: true }`

**DELETE** – Přestat sledovat uživatele
- Smazat záznam z `user_follows` kde `follower_id = currentUserId AND following_id = targetId`
- Vrátit `{ ok: true }`

### 2A.2 Veřejný profil API (`src/app/api/users/[id]/route.ts`)

**GET** – Vrátit veřejný profil uživatele
- Načíst uživatele z `users` podle ID nebo nicknamu
- Spočítat followers/following agregací z `user_follows`
- Načíst počet navštívených zemí z `user_visited_countries`
- Načíst počet článků z `articles` kde `status = 'approved'`
- Pokud je přihlášen aktuální uživatel, zjistit `isFollowedByMe` a `isFollowingMe`
- Vrátit `PublicProfile`

### 2A.3 Seznam sledujících/sledovaných (`src/app/api/users/[id]/followers/route.ts`, `src/app/api/users/[id]/following/route.ts`)

**GET /followers** – Seznam uživatelů, kteří sledují daného uživatele
**GET /following** – Seznam uživatelů, které daný uživatel sleduje

Vrací: `{ items: PublicProfile[], total: number }`

### 2A.4 Seznam přátel (`src/app/api/users/[id]/friends/route.ts`)

**GET** – Uživatelé s obousměrným sledováním
- SQL: průnik `user_follows` kde A sleduje B a B sleduje A
- Pro využití v community filtru "články od přátel"

---

## Fáze 2B – UI Komponenty a stránky

### 2B.1 Veřejný profil stránka (`src/app/profil/[nickname]/page.tsx`)

Nová stránka zobrazující veřejný profil libovolného uživatele:
- Header: avatar, jméno/nickname, bio
- Statistiky: navštívené země, články, sledující, sleduje
- Tlačítko "Sledovat" / "Přestat sledovat" (pokud není vlastní profil)
- Indikátor přátelství (pokud je obousměrné sledování)
- Mapa navštívených zemí (read-only verze `DashboardPublicWorldMap`)
- Seznam schválených článků uživatele

### 2B.2 Úprava Dashboard (`src/app/dashboard/page.tsx`)

- Přidat odkaz "Zobrazit veřejný profil" → `/profil/[nickname]`
- Kliknutím na počet sledujících/sledovaných otevřít modal se seznamem
- Ponechat možnost editace avataru pouze na dashboardu (vlastní profil)

### 2B.3 Modal/drawer seznam sledujících (`src/components/profile/FollowersModal.tsx`)

Komponenta zobrazující seznam uživatelů s možností:
- Klik na uživatele → přechod na jeho profil
- Tlačítko follow/unfollow u každého uživatele
- Lazy loading / pagination pro velké seznamy

### 2B.4 Follow tlačítko komponenta (`src/components/profile/FollowButton.tsx`)

Znovupoužitelná komponenta:
- Props: `userId`, `isFollowing`, `onToggle`
- Stavy: "Sledovat", "Sledujete" (hover: "Přestat sledovat")
- Loading state během API volání

### 2B.5 Úprava Community page (`src/app/community/page.tsx`)

- Tab "Sleduji" – načíst články pouze od sledovaných uživatelů
- Přidat filtr "Články od přátel" (obousměrné sledování)
- API volání na `/api/articles?following=true` nebo `?friends=true`

### 2B.6 Úprava Articles API (`src/app/api/articles/route.ts`)

Přidat query parametry:
- `following=true` – články od uživatelů, které aktuální uživatel sleduje
- `friends=true` – články od přátel (obousměrné sledování)

---

## Fáze 2C – Utility funkce

### 2C.1 Rozšíření `src/utils/supabase-db.ts`

```typescript
// Sledování
followUser(currentUserId: string, targetUserId: string): Promise<void>
unfollowUser(currentUserId: string, targetUserId: string): Promise<void>
getFollowers(userId: string): Promise<PublicProfile[]>
getFollowing(userId: string): Promise<PublicProfile[]>
getFriends(userId: string): Promise<PublicProfile[]>
getFollowCounts(userId: string): Promise<{ followers: number, following: number }>
isFollowing(currentUserId: string, targetUserId: string): Promise<boolean>
```

### 2C.2 Aktualizace `getUserStats` v `src/utils/supabase-db.ts`

Nahradit mock hodnoty `followers`/`following` skutečnými počty z `user_follows` tabulky.

---

## Soubory k vytvoření

| Soubor | Popis |
|--------|-------|
| `src/app/profil/[nickname]/page.tsx` | Veřejný profil uživatele |
| `src/app/api/users/[id]/route.ts` | GET veřejný profil |
| `src/app/api/users/[id]/follow/route.ts` | POST/DELETE follow |
| `src/app/api/users/[id]/followers/route.ts` | GET seznam sledujících |
| `src/app/api/users/[id]/following/route.ts` | GET seznam sledovaných |
| `src/app/api/users/[id]/friends/route.ts` | GET seznam přátel |
| `src/components/profile/FollowersModal.tsx` | Modal se seznamem |
| `src/components/profile/FollowButton.tsx` | Tlačítko sledování |

## Soubory k úpravě

| Soubor | Změny |
|--------|-------|
| `prisma/schema.prisma` | Nový model `user_follows`, relace v `users` |
| `src/types/database.ts` | Nové typy `UserFollow`, `PublicProfile` |
| `src/utils/supabase-db.ts` | Nové funkce pro sledování, úprava `getUserStats` |
| `src/app/dashboard/page.tsx` | Link na profil, klikatelné počty followers |
| `src/app/community/page.tsx` | Implementace tabu "Sleduji", filtr přátel |
| `src/app/api/articles/route.ts` | Query parametry `following`/`friends` |
| `docs/sql/rls_policies.sql` | RLS pro `user_follows` |

